<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-5xl mx-auto bg-white rounded-lg shadow-xl p-6 md:p-8">
        <header class="flex justify-between items-center mb-8">
            <a href="index.html" class="flex items-center text-indigo-600 hover:text-indigo-800 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                <span class="font-medium">Back to Home</span>
            </a>
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2 text-center flex-grow">Expense Tracker</h1>
        </header>

        <div class="mb-8 p-6 bg-red-50 rounded-lg shadow-sm border border-red-200">
            <h2 class="text-lg font-semibold text-red-700">Total Expenses</h2>
            <p class="text-3xl font-bold text-red-900 mt-2" id="total-expenses">$0.00</p>
        </div>

        <div class="mb-8 p-6 bg-gray-50 rounded-lg shadow-inner">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Add New Expense</h2>
            <form id="expense-form" class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label for="amount" class="block text-sm font-medium text-gray-700">Amount</label>
                        <input type="number" step="0.01" id="amount" name="amount" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500">
                    </div>
                    <div>
                        <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
                        <select id="category" name="category" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500">
                            <option value="">Select Category</option>
                            <option value="Office Supplies">Office Supplies</option>
                            <option value="Travel">Travel</option>
                            <option value="Meals">Meals</option>
                            <option value="Equipment">Equipment</option>
                            <option value="Software">Software</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Utilities">Utilities</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-700">Date</label>
                        <input type="date" id="date" name="date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500">
                    </div>
                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                        <input type="text" id="description" name="description" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500">
                    </div>
                </div>
                <button type="submit" class="w-full bg-red-600 text-white font-medium py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">Add Expense</button>
            </form>
        </div>

        <div>
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Expenses</h2>
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="expenses-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- Expenses will be loaded here dynamically -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Loading indicator -->
        <div id="loading" class="hidden text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-red-600"></div>
            <p class="mt-2 text-gray-600">Loading expenses...</p>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Confirm Deletion</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">Are you sure you want to delete this expense? This action cannot be undone.</p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="confirm-delete" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">Delete</button>
                    <button id="cancel-delete" class="mt-3 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div id="message-container" class="fixed top-4 right-4 z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getFirestore,
            collection,
            addDoc,
            getDocs,
            deleteDoc,
            doc,
            query,
            where,
            orderBy
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD9SrWqQVL0_GxfBISBBezUOqQMbE_fiRU",
            authDomain: "invoicing-platform-f29ac.firebaseapp.com",
            projectId: "invoicing-platform-f29ac",
            storageBucket: "invoicing-platform-f29ac.firebasestorage.app",
            messagingSenderId: "632172765378",
            appId: "1:632172765378:web:072134627a2226ddab9b5b",
            measurementId: "G-NSK0H0SQBE"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let user_id = null;
        let expenses = [];
        let expenseToDelete = null;

        // Get or create consistent user ID across tabs (fast, lightweight)
        function getConsistentUserId() {
            let storedUserId = localStorage.getItem('invoicing_user_id');
            if (!storedUserId) {
                // Generate a consistent ID for this browser
                storedUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('invoicing_user_id', storedUserId);
            }
            return storedUserId;
        }

        // Initialize - fast and simple
        async function init() {
            // Use consistent user ID across tabs
            user_id = getConsistentUserId();
            console.log("Using user ID:", user_id);

            // Set today's date as default
            document.getElementById('date').valueAsDate = new Date();

            await loadExpenses();
        }

        // Start immediately when page loads
        init();

        // Show message to user
        function showMessage(message, type = 'success') {
            const container = document.getElementById('message-container');
            const messageDiv = document.createElement('div');

            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';

            messageDiv.innerHTML = `
                <div class="${bgColor} text-white px-6 py-3 rounded-lg shadow-lg mb-4 animate-fade-in">
                    <span>${message}</span>
                </div>
            `;

            container.appendChild(messageDiv);

            // Remove after 3 seconds
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // Load expenses from Firestore
        async function loadExpenses() {
            if (!user_id) {
                console.log("No userId available for loading expenses");
                return;
            }

            const loading = document.getElementById('loading');
            loading.classList.remove('hidden');

            try {
                const q = query(
                    collection(db, "expenses"),
                    where("user_id", "==", user_id),
                    orderBy("expense_date", "desc")
                );

                const querySnapshot = await getDocs(q);

                expenses = [];
                querySnapshot.forEach((doc) => {
                    expenses.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                console.log("Loaded expenses:", expenses);
                displayExpenses(expenses);
                updateTotalExpenses();
            } catch (error) {
                console.error("Error loading expenses:", error);
                showMessage('Failed to load expenses', 'error');
            } finally {
                loading.classList.add('hidden');
            }
        }

        // Display expenses in table
        function displayExpenses(expensesToShow) {
            const tbody = document.getElementById('expenses-tbody');

            if (!expensesToShow || expensesToShow.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No expenses added yet.</td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = expensesToShow.map(expense => {
                const expenseDate = expense.expense_date?.toDate ?
                    expense.expense_date.toDate() :
                    new Date(expense.expense_date);

                return `
                    <tr class="hover:bg-gray-100 transition-colors duration-200">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${parseFloat(expense.amount || 0).toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${expense.category || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${expenseDate.toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${expense.description || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <button type="button" class="delete-btn text-red-600 hover:text-red-900 transition-colors duration-200" onclick="deleteExpense('${expense.id}')" title="Delete Expense">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update total expenses display
        function updateTotalExpenses() {
            const total = expenses.reduce((sum, expense) => sum + (expense.amount || 0), 0);
            const totalElement = document.getElementById('total-expenses');
            totalElement.textContent = `$${total.toFixed(2)}`;
        }

        // Add new expense
        document.getElementById('expense-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!user_id) {
                showMessage("Error: No user ID available", 'error');
                return;
            }

            const formData = new FormData(e.target);
            const expenseData = {
                amount: parseFloat(formData.get('amount')),
                category: formData.get('category'),
                expense_date: new Date(formData.get('date')),
                description: formData.get('description') || '',
                user_id: user_id,
                createdAt: new Date()
            };

            console.log("Adding expense:", expenseData);

            try {
                const docRef = await addDoc(collection(db, "expenses"), expenseData);
                console.log("Expense added with ID:", docRef.id);

                // Add to local array
                expenses.unshift({
                    id: docRef.id,
                    ...expenseData
                });

                displayExpenses(expenses);
                updateTotalExpenses();

                // Reset form
                e.target.reset();
                document.getElementById('date').valueAsDate = new Date();

                showMessage('Expense added successfully!');
            } catch (error) {
                console.error("Error adding expense:", error);
                showMessage('Failed to add expense', 'error');
            }
        });

        // Delete expense
        window.deleteExpense = (expenseId) => {
            expenseToDelete = expenseId;
            document.getElementById('delete-modal').classList.remove('hidden');
        };

        // Confirm delete
        document.getElementById('confirm-delete').addEventListener('click', async () => {
            if (!expenseToDelete) return;

            try {
                await deleteDoc(doc(db, "expenses", expenseToDelete));

                // Remove from local array
                expenses = expenses.filter(exp => exp.id !== expenseToDelete);

                displayExpenses(expenses);
                updateTotalExpenses();

                document.getElementById('delete-modal').classList.add('hidden');
                expenseToDelete = null;

                showMessage('Expense deleted successfully!');
            } catch (error) {
                console.error("Error deleting expense:", error);
                showMessage('Failed to delete expense', 'error');
            }
        });

        // Cancel delete
        document.getElementById('cancel-delete').addEventListener('click', () => {
            document.getElementById('delete-modal').classList.add('hidden');
            expenseToDelete = null;
        });
    </script>

    <style>
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }
    </style>
</body>
</html>