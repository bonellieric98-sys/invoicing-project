<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Insights</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .insight-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 1rem;
            padding: 1.5rem;
            color: white;
            position: relative;
            overflow: hidden;
        }
        .insight-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }
        .metric-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .metric-card:hover {
            transform: translateY(-2px);
        }
        .trend-up {
            color: #10b981;
        }
        .trend-down {
            color: #ef4444;
        }
        .trend-neutral {
            color: #6b7280;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div class="flex items-center">
                <a href="/invoicing-project/index.html" class="flex items-center text-indigo-600 hover:text-indigo-800 transition-colors mr-6">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    <span class="font-medium">Back to Home</span>
                </a>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Money Insights</h1>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                <span class="text-sm text-gray-500">Gemini AI Analysis Active</span>
            </div>
        </div>

        <!-- API Key Missing Alert -->
        <div id="api-key-alert" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">Gemini API Key Required</h3>
                    <p class="mt-1 text-sm text-red-700">Please set your Gemini API key in localStorage to enable AI insights. You can get one from Google AI Studio.</p>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
            <p class="mt-4 text-gray-500">Analyzing your financial data with Gemini AI...</p>
        </div>

        <!-- Main Content -->
        <div id="main-content" class="hidden">
            <!-- AI Insight Hero Card -->
            <div class="insight-card mb-8 relative z-10">
                <div class="flex items-start justify-between">
                    <div>
                        <h2 class="text-xl font-bold mb-2">ðŸ¤– Gemini AI Recommendation</h2>
                        <p id="ai-insight" class="text-lg leading-relaxed">
                            Analyzing your financial patterns to provide personalized insights...
                        </p>
                    </div>
                    <div class="text-4xl opacity-20">ðŸ§ </div>
                </div>
            </div>

            <!-- Financial Health Score -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="metric-card text-center">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Financial Health Score</h3>
                    <div class="text-4xl font-bold text-indigo-600 mb-2" id="health-score">--</div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-indigo-600 h-2 rounded-full transition-all duration-500" id="health-bar" style="width: 0%"></div>
                    </div>
                    <p class="text-sm text-gray-500 mt-2" id="health-description">Calculating...</p>
                </div>

                <div class="metric-card text-center">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Cash Flow Trend</h3>
                    <div class="text-2xl font-bold trend-neutral mb-2" id="cash-flow-trend">--</div>
                    <p class="text-sm text-gray-500">vs last period</p>
                </div>

                <div class="metric-card text-center">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Expense Efficiency</h3>
                    <div class="text-2xl font-bold trend-neutral mb-2" id="expense-efficiency">--</div>
                    <p class="text-sm text-gray-500" id="efficiency-description">Analyzing...</p>
                </div>
            </div>

            <!-- Insights Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Revenue Insights -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">ðŸ“Š Revenue Insights</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                            <span class="text-sm font-medium">Total Revenue</span>
                            <span class="text-sm text-green-600 font-bold" id="total-revenue">$--</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                            <span class="text-sm font-medium">Average Transaction</span>
                            <span class="text-sm text-blue-600 font-bold" id="avg-transaction">$--</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                            <span class="text-sm font-medium">Revenue Growth</span>
                            <span class="text-sm text-purple-600 font-bold" id="revenue-growth">--%</span>
                        </div>
                    </div>
                </div>

                <!-- Expense Insights -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">ðŸ’³ Expense Insights</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                            <span class="text-sm font-medium">Total Expenses</span>
                            <span class="text-sm text-red-600 font-bold" id="total-expenses">$--</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                            <span class="text-sm font-medium">Largest Category</span>
                            <span class="text-sm text-yellow-600 font-bold" id="largest-category">--</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-orange-50 rounded-lg">
                            <span class="text-sm font-medium">Expense Ratio</span>
                            <span class="text-sm text-orange-600 font-bold" id="expense-ratio">--%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Recommendations -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">ðŸŽ¯ Gemini AI Recommendations</h3>
                <div id="ai-recommendations" class="space-y-4">
                    <div class="animate-pulse">
                        <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                        <div class="h-3 bg-gray-200 rounded w-1/2"></div>
                    </div>
                </div>
            </div>

            <!-- Forecast -->
            <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg shadow-md p-6 text-white">
                <h3 class="text-xl font-semibold mb-4">ðŸ”® AI-Powered 30-Day Forecast</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="text-center">
                        <p class="text-sm opacity-80">Projected Revenue</p>
                        <p class="text-2xl font-bold" id="forecast-revenue">$--</p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm opacity-80">Expected Expenses</p>
                        <p class="text-2xl font-bold" id="forecast-expenses">$--</p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm opacity-80">Net Profit</p>
                        <p class="text-2xl font-bold" id="forecast-profit">$--</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD9SrWqQVL0_GxfBISBBezUOqQMbE_fiRU",
            authDomain: "invoicing-platform-f29ac.firebaseapp.com",
            projectId: "invoicing-platform-f29ac",
            storageBucket: "invoicing-platform-f29ac.firebasestorage.app",
            messagingSenderId: "632172765378",
            appId: "1:632172765378:web:072134627a2226ddab9b5b",
            measurementId: "G-NSK0H0SQBE"
        };

        let db, auth;
        let user_id = null;

        // Check for Gemini API key
        function getGeminiApiKey() {
            return localStorage.getItem('geminiApiKey');
        }

        // Call Gemini API for financial analysis
        async function analyzeWithGemini(financialData) {
            const apiKey = getGeminiApiKey();
            if (!apiKey) {
                throw new Error('Gemini API key not found in localStorage');
            }

            const prompt = `You are a financial analyst AI. Analyze the following financial data and provide insights in JSON format.

Financial Data:
- Total Revenue: $${financialData.totalRevenue}
- Total Expenses: $${financialData.totalExpenses}
- Total Deposits: $${financialData.totalDeposits}
- Total Withdrawals: $${financialData.totalWithdrawals}
- Net Profit: $${financialData.netProfit}
- Number of Revenue Transactions: ${financialData.revenueCount}
- Number of Expense Transactions: ${financialData.expenseCount}
- Expense Categories: ${JSON.stringify(financialData.expenseCategories)}
- Monthly Trend: ${financialData.monthlyTrend}

Please respond with a JSON object containing:
{
  "healthScore": number (0-100),
  "healthDescription": string,
  "cashFlowTrend": string (e.g., "+15.2%"),
  "cashFlowDirection": string ("up", "down", or "neutral"),
  "expenseEfficiency": number (0-100),
  "efficiencyDescription": string,
  "avgTransaction": number,
  "revenueGrowth": string (e.g., "+12.5%"),
  "largestCategory": string,
  "expenseRatio": string (e.g., "45%"),
  "mainInsight": string (1-2 sentences),
  "recommendations": [
    {
      "title": string,
      "description": string,
      "color": string ("green", "blue", "purple", "orange")
    }
  ],
  "forecast": {
    "revenue": number,
    "expenses": number,
    "profit": number
  }
}

Focus on actionable insights and be specific about the numbers provided.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`Gemini API error: ${response.status}`);
                }

                const data = await response.json();
                const content = data.candidates[0].content.parts[0].text;

                // Extract JSON from the response
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    throw new Error('No valid JSON found in Gemini response');
                }

                return JSON.parse(jsonMatch[0]);
            } catch (error) {
                console.error('Gemini API error:', error);
                throw error;
            }
        }

        // Process and display insights
        function displayInsights(analysis) {
            // Update health score
            document.getElementById('health-score').textContent = analysis.healthScore;
            document.getElementById('health-bar').style.width = analysis.healthScore + '%';
            document.getElementById('health-description').textContent = analysis.healthDescription;

            // Update cash flow trend
            const cashFlowElement = document.getElementById('cash-flow-trend');
            cashFlowElement.textContent = analysis.cashFlowTrend;
            cashFlowElement.className = `text-2xl font-bold trend-${analysis.cashFlowDirection}`;

            // Update expense efficiency
            document.getElementById('expense-efficiency').textContent = analysis.expenseEfficiency;
            document.getElementById('efficiency-description').textContent = analysis.efficiencyDescription;

            // Update revenue insights
            document.getElementById('avg-transaction').textContent = `$${analysis.avgTransaction.toFixed(0)}`;
            document.getElementById('revenue-growth').textContent = analysis.revenueGrowth;

            // Update expense insights
            document.getElementById('largest-category').textContent = analysis.largestCategory;
            document.getElementById('expense-ratio').textContent = analysis.expenseRatio;

            // Update main AI insight
            document.getElementById('ai-insight').textContent = analysis.mainInsight;

            // Update recommendations
            const recommendationsContainer = document.getElementById('ai-recommendations');
            recommendationsContainer.innerHTML = '';

            analysis.recommendations.forEach(rec => {
                const colorMap = {
                    green: 'border-green-500 text-green-700',
                    blue: 'border-blue-500 text-blue-700',
                    purple: 'border-purple-500 text-purple-700',
                    orange: 'border-orange-500 text-orange-700'
                };

                const recElement = document.createElement('div');
                recElement.className = `border-l-4 ${colorMap[rec.color]} pl-4 py-2`;
                recElement.innerHTML = `
                    <h4 class="font-semibold">${rec.title}</h4>
                    <p class="text-sm text-gray-600">${rec.description}</p>
                `;
                recommendationsContainer.appendChild(recElement);
            });

            // Update forecast
            document.getElementById('forecast-revenue').textContent = `$${analysis.forecast.revenue.toFixed(0)}`;
            document.getElementById('forecast-expenses').textContent = `$${analysis.forecast.expenses.toFixed(0)}`;
            document.getElementById('forecast-profit').textContent = `$${analysis.forecast.profit.toFixed(0)}`;
        }

        // Prepare financial data for analysis
        function prepareFinancialData(invoices, expenses, bankAnalyses) {
            const paidInvoices = invoices.filter(inv => inv.status === 'Paid');
            const totalRevenue = paidInvoices.reduce((sum, inv) => sum + (parseFloat(inv.amount) || 0), 0);
            const totalExpenses = expenses.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);

            const totalDeposits = bankAnalyses.reduce((sum, analysis) => sum + (parseFloat(analysis.revenue) || 0), 0);
            const totalWithdrawals = bankAnalyses.reduce((sum, analysis) => sum + (parseFloat(analysis.expenses) || 0), 0);

            const netProfit = (totalRevenue + totalDeposits) - (totalExpenses + totalWithdrawals);

            // Calculate expense categories
            const expenseCategories = {};
            expenses.forEach(expense => {
                const category = expense.category || 'Other';
                expenseCategories[category] = (expenseCategories[category] || 0) + (parseFloat(expense.amount) || 0);
            });

            // Update basic metrics
            document.getElementById('total-revenue').textContent = `$${(totalRevenue + totalDeposits).toFixed(0)}`;
            document.getElementById('total-expenses').textContent = `$${(totalExpenses + totalWithdrawals).toFixed(0)}`;

            return {
                totalRevenue: totalRevenue + totalDeposits,
                totalExpenses: totalExpenses + totalWithdrawals,
                totalDeposits,
                totalWithdrawals,
                netProfit,
                revenueCount: paidInvoices.length,
                expenseCount: expenses.length,
                expenseCategories,
                monthlyTrend: netProfit > 0 ? 'positive' : 'negative'
            };
        }

        async function loadUserData() {
            if (!user_id) return;

            try {
                // Check for API key
                const apiKey = getGeminiApiKey();
                if (!apiKey) {
                    document.getElementById('api-key-alert').classList.remove('hidden');
                    document.getElementById('loading').classList.add('hidden');
                    return;
                }

                // Load invoices
                const invoicesQuery = query(collection(db, "invoices"), where("user_id", "==", user_id), limit(50));
                const invoicesSnapshot = await getDocs(invoicesQuery);
                const invoices = invoicesSnapshot.docs.map(doc => doc.data());

                // Load expenses
                const expensesQuery = query(collection(db, "expenses"), where("user_id", "==", user_id), limit(50));
                const expensesSnapshot = await getDocs(expensesQuery);
                const expenses = expensesSnapshot.docs.map(doc => doc.data());

                // Load bank analyses
                const bankQuery = query(collection(db, "bank_analyses"), where("user_id", "==", user_id), limit(10));
                const bankSnapshot = await getDocs(bankQuery);
                const bankAnalyses = bankSnapshot.docs.map(doc => doc.data());

                // Prepare data for Gemini
                const financialData = prepareFinancialData(invoices, expenses, bankAnalyses);

                // Get AI analysis
                const analysis = await analyzeWithGemini(financialData);

                // Display insights
                displayInsights(analysis);

                // Show content
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');

            } catch (error) {
                console.error("Error loading data or calling Gemini:", error);
                document.getElementById('loading').innerHTML = `
                    <p class="text-red-500">Failed to load insights: ${error.message}</p>
                    <p class="text-sm text-gray-500 mt-2">Make sure your Gemini API key is set in localStorage</p>
                `;
            }
        }

        window.addEventListener('load', async () => {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                await signInAnonymously(auth);

                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        user_id = user.uid;
                        // Add delay for dramatic effect
                        setTimeout(async () => {
                            await loadUserData();
                        }, 2000);
                    } else {
                        document.getElementById('loading').innerHTML = '<p class="text-red-500">Authentication failed</p>';
                    }
                });

            } catch (error) {
                console.error("Firebase initialization error:", error);
                document.getElementById('loading').innerHTML = '<p class="text-red-500">Failed to initialize insights</p>';
            }
        });
    </script>
</body>
</html>
