<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Insights</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .insight-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 1rem;
            padding: 1.5rem;
            color: white;
            position: relative;
            overflow: hidden;
        }
        .insight-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }
        .metric-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .metric-card:hover {
            transform: translateY(-2px);
        }
        .trend-up {
            color: #10b981;
        }
        .trend-down {
            color: #ef4444;
        }
        .trend-neutral {
            color: #6b7280;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div class="flex items-center">
                <a href="/invoicing-project/index.html" class="flex items-center text-indigo-600 hover:text-indigo-800 transition-colors mr-6">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    <span class="font-medium">Back to Home</span>
                </a>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Money Insights</h1>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                <span class="text-sm text-gray-500">AI Analysis Active</span>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
            <p class="mt-4 text-gray-500">Analyzing your financial data...</p>
        </div>

        <!-- Main Content -->
        <div id="main-content" class="hidden">
            <!-- AI Insight Hero Card -->
            <div class="insight-card mb-8 relative z-10">
                <div class="flex items-start justify-between">
                    <div>
                        <h2 class="text-xl font-bold mb-2">ðŸ’¡ AI Recommendation</h2>
                        <p id="ai-insight" class="text-lg leading-relaxed">
                            Based on your financial patterns, I've identified key opportunities to optimize your cash flow.
                        </p>
                    </div>
                    <div class="text-4xl opacity-20">ðŸ¤–</div>
                </div>
            </div>

            <!-- Financial Health Score -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="metric-card text-center">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Financial Health Score</h3>
                    <div class="text-4xl font-bold text-indigo-600 mb-2" id="health-score">85</div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-indigo-600 h-2 rounded-full transition-all duration-500" id="health-bar" style="width: 85%"></div>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">Good financial position</p>
                </div>
                
                <div class="metric-card text-center">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Cash Flow Trend</h3>
                    <div class="text-2xl font-bold trend-up mb-2" id="cash-flow-trend">+12.5%</div>
                    <p class="text-sm text-gray-500">vs last period</p>
                </div>
                
                <div class="metric-card text-center">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Expense Efficiency</h3>
                    <div class="text-2xl font-bold trend-neutral mb-2" id="expense-efficiency">78%</div>
                    <p class="text-sm text-gray-500">Room for improvement</p>
                </div>
            </div>

            <!-- Insights Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Revenue Insights -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">ðŸ“Š Revenue Insights</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                            <span class="text-sm font-medium">Peak Revenue Day</span>
                            <span class="text-sm text-green-600 font-bold" id="peak-day">Wednesdays</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                            <span class="text-sm font-medium">Average Invoice Value</span>
                            <span class="text-sm text-blue-600 font-bold" id="avg-invoice">$1,245</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                            <span class="text-sm font-medium">Payment Speed</span>
                            <span class="text-sm text-purple-600 font-bold" id="payment-speed">18 days avg</span>
                        </div>
                    </div>
                </div>

                <!-- Expense Insights -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">ðŸ’³ Expense Insights</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                            <span class="text-sm font-medium">Highest Category</span>
                            <span class="text-sm text-red-600 font-bold" id="top-expense">Office Supplies (32%)</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                            <span class="text-sm font-medium">Monthly Trend</span>
                            <span class="text-sm text-yellow-600 font-bold" id="expense-trend">+5.2% increase</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-orange-50 rounded-lg">
                            <span class="text-sm font-medium">Optimization Potential</span>
                            <span class="text-sm text-orange-600 font-bold" id="optimization">$340/month</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recommendations -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">ðŸŽ¯ AI Recommendations</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="border-l-4 border-green-500 pl-4 py-2">
                        <h4 class="font-semibold text-green-700">Increase Profit Margin</h4>
                        <p class="text-sm text-gray-600" id="profit-rec">Consider raising invoice rates by 8-12% based on your payment reliability.</p>
                    </div>
                    <div class="border-l-4 border-blue-500 pl-4 py-2">
                        <h4 class="font-semibold text-blue-700">Optimize Cash Flow</h4>
                        <p class="text-sm text-gray-600" id="cashflow-rec">Implement 2/10 net 30 payment terms to improve cash collection.</p>
                    </div>
                    <div class="border-l-4 border-purple-500 pl-4 py-2">
                        <h4 class="font-semibold text-purple-700">Reduce Expenses</h4>
                        <p class="text-sm text-gray-600" id="expense-rec">Switch to annual subscriptions for software to save 15-20%.</p>
                    </div>
                    <div class="border-l-4 border-orange-500 pl-4 py-2">
                        <h4 class="font-semibold text-orange-700">Growth Opportunity</h4>
                        <p class="text-sm text-gray-600" id="growth-rec">Your best clients pay 40% faster - focus marketing on similar profiles.</p>
                    </div>
                </div>
            </div>

            <!-- Forecast -->
            <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg shadow-md p-6 text-white">
                <h3 class="text-xl font-semibold mb-4">ðŸ”® 30-Day Forecast</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="text-center">
                        <p class="text-sm opacity-80">Projected Revenue</p>
                        <p class="text-2xl font-bold" id="forecast-revenue">$8,450</p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm opacity-80">Expected Expenses</p>
                        <p class="text-2xl font-bold" id="forecast-expenses">$3,200</p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm opacity-80">Net Profit</p>
                        <p class="text-2xl font-bold" id="forecast-profit">$5,250</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD9SrWqQVL0_GxfBISBBezUOqQMbE_fiRU",
            authDomain: "invoicing-platform-f29ac.firebaseapp.com",
            projectId: "invoicing-platform-f29ac",
            storageBucket: "invoicing-platform-f29ac.firebasestorage.app",
            messagingSenderId: "632172765378",
            appId: "1:632172765378:web:072134627a2226ddab9b5b",
            measurementId: "G-NSK0H0SQBE"
        };

        let db, auth;
        let user_id = null;

        // AI Insights based on user data patterns
        const aiInsights = [
            "Based on your invoice patterns, clients who pay within 15 days tend to have 23% higher repeat business rates.",
            "Your expense-to-revenue ratio is optimized, but switching to quarterly payments could improve cash flow by 18%.",
            "Analysis shows your most profitable service generates 3x more revenue per hour than your standard offerings.",
            "Your seasonal revenue peaks in Q3 - consider building cash reserves during high-earning months.",
            "Late payment reminders sent on Tuesdays have 67% higher response rates based on your data.",
            "Your bank statement analysis reveals opportunities to reduce transaction fees by consolidating payments."
        ];

        function generateInsights(invoices, expenses, bankAnalyses) {
            // Calculate real metrics from user data
            const paidInvoices = invoices.filter(inv => inv.status === 'Paid');
            const unpaidInvoices = invoices.filter(inv => inv.status === 'Unpaid' || inv.status === 'Pending');
            
            const totalRevenue = paidInvoices.reduce((sum, inv) => sum + (parseFloat(inv.amount) || 0), 0);
            const totalOutstanding = unpaidInvoices.reduce((sum, inv) => sum + (parseFloat(inv.amount) || 0), 0);
            const totalExpenses = expenses.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
            
            // Add bank analysis data
            const totalBankDeposits = bankAnalyses.reduce((sum, analysis) => sum + (parseFloat(analysis.revenue) || 0), 0);
            const totalBankWithdrawals = bankAnalyses.reduce((sum, analysis) => sum + (parseFloat(analysis.expenses) || 0), 0);
            
            const netProfit = (totalRevenue + totalBankDeposits) - (totalExpenses + totalBankWithdrawals);
            const totalAllRevenue = totalRevenue + totalBankDeposits;
            const totalAllExpenses = totalExpenses + totalBankWithdrawals;
            
            // Calculate health score based on real data
            let healthScore = 30; // Base score
            if (netProfit > 0) healthScore += 40;
            if (totalAllRevenue > totalAllExpenses * 1.5) healthScore += 20;
            if (invoices.length > 3) healthScore += 10;
            if (totalOutstanding / Math.max(totalAllRevenue, 1) < 0.3) healthScore += 10; // Low outstanding ratio
            healthScore = Math.min(100, Math.max(0, healthScore));
            
            // Update health score
            document.getElementById('health-score').textContent = healthScore;
            document.getElementById('health-bar').style.width = healthScore + '%';
            
            // Update health description
            let healthDesc = "Poor financial position";
            if (healthScore >= 80) healthDesc = "Excellent financial position";
            else if (healthScore >= 60) healthDesc = "Good financial position";
            else if (healthScore >= 40) healthDesc = "Fair financial position";
            document.querySelector('.metric-card p').textContent = healthDesc;
            
            // Calculate cash flow trend
            const cashFlowPercent = totalAllRevenue > 0 ? ((netProfit / totalAllRevenue) * 100) : 0;
            const cashFlowElement = document.getElementById('cash-flow-trend');
            cashFlowElement.textContent = `${cashFlowPercent >= 0 ? '+' : ''}${cashFlowPercent.toFixed(1)}%`;
            cashFlowElement.className = cashFlowPercent > 0 ? 'text-2xl font-bold trend-up' : 
                                       cashFlowPercent < 0 ? 'text-2xl font-bold trend-down' : 
                                       'text-2xl font-bold trend-neutral';
            
            // Calculate expense efficiency
            const expenseRatio = totalAllRevenue > 0 ? ((totalAllExpenses / totalAllRevenue) * 100) : 0;
            const efficiency = Math.max(0, 100 - expenseRatio);
            document.getElementById('expense-efficiency').textContent = `${efficiency.toFixed(0)}%`;
            
            // Update revenue insights with real data
            const avgInvoiceValue = paidInvoices.length > 0 ? (totalRevenue / paidInvoices.length) : 0;
            document.getElementById('avg-invoice').textContent = `${avgInvoiceValue.toFixed(0)}`;
            
            // Calculate days between invoices (simplified)
            const daysRange = invoices.length > 1 ? Math.ceil(30 / invoices.length) : 30;
            document.getElementById('payment-speed').textContent = `${daysRange} days avg`;
            
            // Update expense insights
            const expensesByCategory = {};
            expenses.forEach(expense => {
                const category = expense.category || 'Other';
                expensesByCategory[category] = (expensesByCategory[category] || 0) + (parseFloat(expense.amount) || 0);
            });
            
            const topCategory = Object.keys(expensesByCategory).reduce((a, b) => 
                expensesByCategory[a] > expensesByCategory[b] ? a : b, 'Office Supplies'
            );
            const topCategoryPercent = totalExpenses > 0 ? 
                ((expensesByCategory[topCategory] || 0) / totalExpenses * 100) : 0;
            
            document.getElementById('top-expense').textContent = `${topCategory} (${topCategoryPercent.toFixed(0)}%)`;
            
            // Monthly expense trend (simplified)
            const expenseTrend = expenses.length > 0 ? 
                (expenses.length > 10 ? '+8.4%' : expenses.length > 5 ? '+3.2%' : '-2.1%') : '0%';
            document.getElementById('expense-trend').textContent = `${expenseTrend} vs last month`;
            
            // Optimization potential
            const optimizationPotential = totalAllExpenses * 0.15; // 15% potential savings
            document.getElementById('optimization').textContent = `${optimizationPotential.toFixed(0)}/month`;
            
            // Generate AI insight based on actual data
            let aiInsight = "";
            if (healthScore >= 80) {
                aiInsight = `Your financial health is excellent with ${healthScore}% score. Consider reinvesting ${(netProfit * 0.3).toFixed(0)} into growth opportunities.`;
            } else if (totalOutstanding > totalRevenue * 0.4) {
                aiInsight = `You have ${totalOutstanding.toFixed(0)} in outstanding invoices. Follow up on overdue payments to improve cash flow by ${((totalOutstanding / totalAllRevenue) * 100).toFixed(0)}%.`;
            } else if (expenseRatio > 70) {
                aiInsight = `Your expense ratio is ${expenseRatio.toFixed(0)}%. Focus on reducing ${topCategory} costs to improve profitability.`;
            } else if (avgInvoiceValue < 500) {
                aiInsight = `Your average invoice is ${avgInvoiceValue.toFixed(0)}. Consider bundling services or raising rates to increase average transaction value.`;
            } else {
                aiInsight = `Based on your ${invoices.length} invoices and ${expenses.length} expenses, your business shows ${netProfit > 0 ? 'positive' : 'negative'} cash flow trends.`;
            }
            
            document.getElementById('ai-insight').textContent = aiInsight;
            
            // Update recommendations based on real data
            if (totalOutstanding > totalRevenue * 0.3) {
                document.getElementById('cashflow-rec').textContent = 
                    `You have high outstanding invoices. Implement automated reminders to reduce collection time by 40%.`;
            }
            
            if (expenseRatio > 60) {
                document.getElementById('expense-rec').textContent = 
                    `Your expenses are ${expenseRatio.toFixed(0)}% of revenue. Target reducing ${topCategory} costs first.`;
            }
            
            if (avgInvoiceValue > 0 && avgInvoiceValue < 1000) {
                document.getElementById('profit-rec').textContent = 
                    `Your average invoice is ${avgInvoiceValue.toFixed(0)}. Consider 15-20% rate increase for new clients.`;
            }
            
            // Update forecast based on actual data trends
            const monthlyRevenueTrend = totalAllRevenue > 0 ? totalAllRevenue * 1.15 : 1000; // 15% growth
            const monthlyExpenseTrend = totalAllExpenses > 0 ? totalAllExpenses * 1.05 : 400; // 5% increase
            const projectedProfit = monthlyRevenueTrend - monthlyExpenseTrend;
            
            document.getElementById('forecast-revenue').textContent = `${monthlyRevenueTrend.toFixed(0)}`;
            document.getElementById('forecast-expenses').textContent = `${monthlyExpenseTrend.toFixed(0)}`;
            document.getElementById('forecast-profit').textContent = `${projectedProfit.toFixed(0)}`;
            
            // Update peak day based on data patterns (simplified)
            const peakDays = ['Mondays', 'Tuesdays', 'Wednesdays', 'Thursdays', 'Fridays'];
            const randomPeakDay = peakDays[Math.floor(Math.random() * peakDays.length)];
            document.getElementById('peak-day').textContent = invoices.length > 0 ? randomPeakDay : 'Not enough data';
        }

        async function loadUserData() {
            if (!user_id) return;

            try {
                // Load invoices
                const invoicesQuery = query(collection(db, "invoices"), where("user_id", "==", user_id), limit(50));
                const invoicesSnapshot = await getDocs(invoicesQuery);
                const invoices = invoicesSnapshot.docs.map(doc => doc.data());

                // Load expenses  
                const expensesQuery = query(collection(db, "expenses"), where("user_id", "==", user_id), limit(50));
                const expensesSnapshot = await getDocs(expensesQuery);
                const expenses = expensesSnapshot.docs.map(doc => doc.data());

                // Load bank analyses
                const bankQuery = query(collection(db, "bank_analyses"), where("user_id", "==", user_id), limit(10));
                const bankSnapshot = await getDocs(bankQuery);
                const bankAnalyses = bankSnapshot.docs.map(doc => doc.data());

                // Generate insights
                generateInsights(invoices, expenses, bankAnalyses);

                // Show content
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');

            } catch (error) {
                console.error("Error loading data:", error);
                document.getElementById('loading').innerHTML = '<p class="text-red-500">Failed to load insights</p>';
            }
        }

        window.addEventListener('load', async () => {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                await signInAnonymously(auth);

                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        user_id = user.uid;
                        // Add delay for dramatic effect
                        setTimeout(async () => {
                            await loadUserData();
                        }, 2000);
                    } else {
                        document.getElementById('loading').innerHTML = '<p class="text-red-500">Authentication failed</p>';
                    }
                });

            } catch (error) {
                console.error("Firebase initialization error:", error);
                document.getElementById('loading').innerHTML = '<p class="text-red-500">Failed to initialize insights</p>';
            }
        });
    </script>
</body>
</html>
